# 虹桥 (Bifrost) 局域网文件传输助手 - 开发指导文档

## 1. 前言

本文档为**虹桥 (Bifrost) 局域网文件传输助手**项目提供开发指导，旨在确保代码的规范性、可维护性、可扩展性及应对变化的能力。所有开发人员应遵循此文档进行开发，以保障项目的质量与一致性。

## 2. 总体开发原则

### 2.1 面向对象设计原则

遵循面向对象的设计原则，确保代码结构清晰、模块化、易于扩展。

- **抽象**：通过接口和抽象类隐藏实现细节，确保模块之间松耦合。
- **封装**：类内部封装数据与行为，仅暴露必要接口，避免外部直接操作内部实现。
- **继承与多态**：利用继承复用代码，使用多态实现接口灵活替换。
- **单一职责原则 (SRP)**：每个类应有且仅有一个引起其变化的原因。
- **开闭原则 (OCP)**：尽可能通过扩展来实现新功能，而不是修改现有代码。
- **接口隔离原则 (ISP)**：将接口拆分为更小、易于理解的功能模块，避免强制依赖不需要的接口。

### 2.2 基于接口的设计

为了应对技术实现频繁变化，所有外部操作（如数据库、文件存储等）应基于接口设计，从而满足开闭原则。

- **接口定义**：如定义 `FileStorage` 和 `Database` 接口，便于替换底层实现。
- **实现与依赖注入**：通过依赖注入（如 `get_it`）实现具体的存储或数据库操作类的替换，避免硬编码。

### 2.3 设计模式的应用

在合适的场景下，使用设计模式来提升代码的可复用性和可扩展性。

- **工厂模式**：根据平台或需求变化，动态创建不同的对象。
- **适配器模式**：适配不同平台或API，确保跨平台兼容性。
- **策略模式**：根据不同的条件动态选择文件上传策略等。

### 2.4 避免硬编码

所有常用的字面量（如文件路径、时间等）应提取为常量，避免硬编码，以便于维护和修改。

- **常量命名**：全大写，单词间使用下划线分隔。例如：`MAX_FILE_SIZE`。

### 2.5 代码的可扩展性

在编写代码时，始终考虑代码的可扩展性，确保未来能够轻松添加或修改功能。

- **插件化与模块化**：将系统拆分为核心模块和可扩展插件模块。
- **配置化**：通过外部配置管理可变的参数（如API地址），使系统配置灵活。
- **事件驱动**：使用事件机制来解耦系统模块，方便后续功能扩展。

### 2.6 代码适应变化

软件需求与技术都会发生变化，代码应具备良好的适应变化的能力。

- **敏捷开发**：通过快速迭代响应需求变化。
- **自动化测试**：编写单元测试和集成测试，确保代码修改时不引入新问题。

## 3. 具体开发指导

### 3.1 对外操作指导

#### 数据库操作

- 使用 `sqflite` 库进行数据库操作。
- **接口化开发**：数据库操作应基于 `Database` 接口，确保数据库技术实现可替换。
- **依赖注入**：利用依赖注入（如 `get_it`）管理不同数据库实现的实例。

#### 文件系统操作

- 使用 `path_provider` 获取文件路径，`dart:io` 进行文件操作。
- **接口化开发**：文件存储操作应基于 `FileStorage` 接口，确保存储方式可替换。
- **依赖注入**：通过依赖注入将具体存储实现类注入至业务逻辑层。

### 3.2 错误处理

- **自定义异常**：定义具体的异常类，如 `FileStorageException`, `DatabaseException`，以便于定位和处理错误。
- **恢复与记录**：对于可恢复的错误提供重试机制，重要错误记录日志并优雅退出。
- **避免空的 `catch`**：捕获异常时必须处理或记录错误，不应忽视异常。

### 3.3 日志记录

- 使用 `logging` 库进行日志记录。
- **日志级别**：根据情况选择适当的日志级别（如 `INFO`, `ERROR`）。
- **日志输出**：日志应输出到文件，便于调试和问题追踪。

### 3.4 代码结构与组织

- 采用分层架构：UI层、应用逻辑层、网络层、平台适配层等模块化设计。
- **模块化开发**：根据功能划分模块，如文件传输模块、用户管理模块等，降低耦合度。
- **合理命名**：遵循命名规范，确保代码一致性和可读性。

代码结构如下
```ts
lib/         // 主要Dart源代码目录
├── ui/         // UI 层
│   ├── screens/  // 页面级别组件
│   ├── widgets/  // 可重用的小部件
├── application/  // 应用逻辑层
│   ├── services/ // 业务逻辑服务
│   ├── models/   // 数据模型类
│   ├── states/   // 状态管理相关代码
├── network/     // 网络通信层代码
├── platform/    // 平台特定代码适配层
├── common/      // 通用工具类、常量、扩展等
├── main.dart    // 应用入口文件
└── config/      // 配置文件
asset/       // 资源文件
docs/        // 项目文档目录
ios/         // iOS 平台特定文件
android/     // Android 平台特定文件
linux/       // Linux 平台特定文件
macos/       // macOS 平台特定文件
web/         // Web 平台特定文件
.gitignore     // 根目录的 Git 忽略配置文件
windows/.gitignore // Windows 平台特定的 Git 忽略配置文件
ios/.gitignore     // iOS 平台特定的 Git 忽略配置文件
linux/.gitignore   // Linux 平台特定的 Git 忽略配置文件
pubspec.yaml   // Flutter 项目的依赖和配置管理文件
README.md      // 项目的 README 文件
.metadata     // Flutter 工具生成的元数据文件
```

### 3.5 状态管理

- 使用 `provider` 管理应用状态。
- 通过 `ChangeNotifier` 和 `Stream` 等方式简化状态同步，避免过多的状态管理类。

### 3.6 单元测试

- **测试覆盖率**：重点测试核心功能和逻辑，确保代码在修改时不引入新错误。
- **Mock**：使用 `mockito` 模拟外部依赖，隔离单元测试。
- **持续集成**：将单元测试集成至 CI/CD 流程中，确保代码修改后自动检测问题。

### 3.7 命名规范

- **类名**：使用 PascalCase，如 `UserService`。
- **方法与变量名**：使用 camelCase，如 `uploadFile()`, `filePath`。
- **常量**：使用 SNAKE_CASE，如 `MAX_FILE_SIZE`。

## 4. 结语

本文档提供了**虹桥 (Bifrost) 局域网文件传输助手**项目的开发指导。遵循此文档将有助于团队构建高质量、可维护且易于扩展的代码。希望所有开发人员认真学习并遵循这些指导，携手打造卓越的产品！